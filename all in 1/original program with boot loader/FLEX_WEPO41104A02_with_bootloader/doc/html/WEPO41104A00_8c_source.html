<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SPIKE 1.1: WEPO41104A00.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="PROM_RZ_LogoRGB_ohne_pos.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">SPIKE 1.1
   &#160;<span id="projectnumber">WEPO41104A00</span>
   </div>
   <div id="projectbrief">Firmware Flex</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_617804c1fb5864457089ac8352017473.html">P:</a>      </li>
      <li class="navelem"><a class="el" href="dir_32a483bf0a3b52f63a14e8b5d8ed9951.html">Projekte</a>      </li>
      <li class="navelem"><a class="el" href="dir_975359d4bb9ad371f47a6d51f510fe42.html">WEPO</a>      </li>
      <li class="navelem"><a class="el" href="dir_811a7d7d8695d83f4dd4bbafba86e8cf.html">Entwicklung</a>      </li>
      <li class="navelem"><a class="el" href="dir_2bba18886bf9e3ba484fd6b282926808.html">Software</a>      </li>
      <li class="navelem"><a class="el" href="dir_462254a389dbfe4f996bf1d55f845ea5.html">Firmware</a>      </li>
      <li class="navelem"><a class="el" href="dir_de79c7db4a54e93bc8646c129402e669.html">WEPO4110xA00_SPIKE_1.1</a>      </li>
      <li class="navelem"><a class="el" href="dir_cac09c55cc1c02197d3ccbb536a953f3.html">WEPO41104Axx_Flex</a>      </li>
      <li class="navelem"><a class="el" href="dir_7872b52c2bb8b45f885067de97d057d1.html">WEPO41104A00</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">WEPO41104A00.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="WEPO41104A00_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00201"></a>00201 <span class="comment"></span><span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00202"></a>00202  
<a name="l00203"></a>00203 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00204"></a>00204 <span class="comment">// Header Files</span>
<a name="l00205"></a>00205 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="preprocessor">#include &quot;<a class="code" href="WEPO41104A00_8h.html">inc/WEPO41104A00.h</a>&quot;</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00210"></a>00210 <span class="comment">// Global Data</span>
<a name="l00211"></a>00211 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/* Receive and Transmit buffer for the AT86RF231 */</span>
<a name="l00214"></a>00214 <span class="keyword">extern</span> <span class="keyword">volatile</span> <a class="code" href="structat86rf231__frame.html" title="AT86RF231 Frame struct including frame header.">at86rf231_frame</a> <a class="code" href="at86rf231_8c.html#aec9ffeda53c43230755cabac2c49fe45">at86rf231_tx_frame</a>;
<a name="l00215"></a>00215 <span class="keyword">extern</span> <span class="keyword">volatile</span> <a class="code" href="structat86rf231__frame.html" title="AT86RF231 Frame struct including frame header.">at86rf231_frame</a> <a class="code" href="at86rf231_8c.html#aceef37c0e08c31ac1d803e98d9240804">at86rf231_rx_frame</a>;
<a name="l00216"></a>00216 <span class="keyword">extern</span> <a class="code" href="at86_8h.html#a666f35fa9c02396650a934fc41040710" title="AT86RF231 Transceiver states.">tal_state_t</a> <a class="code" href="at86rf231_8c.html#a6ade09700f2f0240942146947398e874">tal_state</a>;
<a name="l00217"></a>00217 <span class="keyword">extern</span> <span class="keyword">volatile</span> uint8_t <a class="code" href="at86rf231_8c.html#aed259dd0360965764131f0bb170ecc7f">tx_end_irq_flag</a>;
<a name="l00218"></a>00218 <span class="keyword">extern</span> <span class="keyword">volatile</span> uint8_t <a class="code" href="at86rf231_8c.html#ad549bbdaa8b879f1cb0a1a89d0af61a5">rx_start_interrupt_flag</a>;
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="WEPO41104A00_8c.html#a60f22a2b5e2f73922599c7216efd9d84">00220</a> int32_t <a class="code" href="WEPO41104A00_8c.html#a60f22a2b5e2f73922599c7216efd9d84">global_cnt</a>;
<a name="l00221"></a><a class="code" href="WEPO41104A00_8c.html#ab14eb7224e6881cf15cb95391749de25">00221</a> uint32_t <a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a> = 0;             <span class="comment">// timeout timer so switch in sleep mode</span>
<a name="l00222"></a><a class="code" href="WEPO41104A00_8c.html#a7deb9081234bdc9cdb6069bb8f05cf6a">00222</a> uint8_t <a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a> = 0;            <span class="comment">// timeslot number in transmitted payload</span>
<a name="l00223"></a><a class="code" href="WEPO41104A00_8c.html#a6ec8e1d5423a97287f5095d86ce2cff7">00223</a> <span class="keyword">volatile</span> uint8_t <a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a> = 1;  <span class="comment">// turn acceleration measurement on if flag = 1</span>
<a name="l00224"></a><a class="code" href="WEPO41104A00_8c.html#accb4ae119b6b85eda30f468b716c6b83">00224</a> <span class="keyword">volatile</span> uint8_t <a class="code" href="WEPO41104A00_8c.html#accb4ae119b6b85eda30f468b716c6b83">timer_flag</a> = 0;        <span class="comment">// flag = 1 if timer interrupt occurred </span>
<a name="l00225"></a><a class="code" href="WEPO41104A00_8c.html#aea4387e91b0a71edb78fc52d7930c71b">00225</a> <span class="keywordtype">signed</span> <span class="keywordtype">int</span> <a class="code" href="ZMD_8h.html#aea4387e91b0a71edb78fc52d7930c71b">offset</a>[4] = { 0 };           <span class="comment">// TODO wird diese Variable gebraucht?</span>
<a name="l00226"></a><a class="code" href="WEPO41104A00_8c.html#a38c1c68ba82dd107cf6dddbc7a564dfd">00226</a> <span class="keyword">volatile</span> int16_t <a class="code" href="WEPO41104A00_8c.html#a38c1c68ba82dd107cf6dddbc7a564dfd">temperature</a> = 0;       <span class="comment">// measurement value of the temperature sensor</span>
<a name="l00227"></a>00227 <span class="preprocessor">#if defined(USE_DS620)</span>
<a name="l00228"></a><a class="code" href="WEPO41104A00_8c.html#a6a816a46f11405edf3d5659f16cf292a">00228</a> <span class="preprocessor"></span>    uint16_t <a class="code" href="WEPO41104A00_8c.html#a6a816a46f11405edf3d5659f16cf292a">temperature_timer</a> = 0;     <span class="comment">// timer vor next measurement</span>
<a name="l00229"></a>00229 <span class="preprocessor">#endif</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>
<a name="l00231"></a><a class="code" href="WEPO41104A00_8c.html#aeafeea74e76af10844f9a3c97db6712e">00231</a> <a class="code" href="structspike__payload.html" title="Spike tx payload data struct.">spike_payload</a> *<a class="code" href="ZMD_8h.html#aeafeea74e76af10844f9a3c97db6712e">ptr_payload_spike</a> = (<a class="code" href="structspike__payload.html" title="Spike tx payload data struct.">spike_payload</a>*) at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#a5c856872df7ffcd650fb1c0ebe1f2f3e">payload</a>;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">/* EEPROM and SRAM */</span>
<a name="l00234"></a><a class="code" href="group__group__SX8723c__service.html#ga7f3aacb710fc6ba60196588850cf6d15">00234</a> <a class="code" href="structeeprom__data.html" title="Data to store in EEPROM.">eeprom_data</a> <a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a> = { 0 };                       <span class="comment">// EEPROM image in SRAM</span>
<a name="l00235"></a><a class="code" href="group__group__SX8723c__service.html#gaebe1dbaacda0e3af18b8493670264e91">00235</a> <a class="code" href="structeeprom__data.html" title="Data to store in EEPROM.">eeprom_data</a> *<a class="code" href="at86rf231_8c.html#aebe1dbaacda0e3af18b8493670264e91">ptr_eeprom_sram_data</a> = &amp;<a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>;      <span class="comment">// pointer to EEPROM image in SRAM</span>
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="WEPO41104A00_8c.html#a481483ea06e2337faecb21a949a199f5">00237</a> <span class="keyword">volatile</span> <span class="keywordtype">bool</span> <a class="code" href="WEPO41104A00_8c.html#a481483ea06e2337faecb21a949a199f5">wdt_interrupt_occurred</a> = <span class="keyword">false</span>;       <span class="comment">// TODO wird die später noch gebraucht?</span>
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="WEPO41104A00_8c.html#ae40ff337454f0c97fab6c6dde6fb70eb">00239</a> <span class="keyword">volatile</span> int16_t <a class="code" href="WEPO41104A00_8c.html#ae40ff337454f0c97fab6c6dde6fb70eb">test</a>[4] = {0};         <span class="comment">// TODO remove: test ank</span>
<a name="l00240"></a><a class="code" href="WEPO41104A00_8c.html#ad63c4e18afd35636c88cab526b3c4a50">00240</a> <span class="keyword">volatile</span> int16_t* <a class="code" href="WEPO41104A00_8c.html#ad63c4e18afd35636c88cab526b3c4a50">p_test</a> = <a class="code" href="WEPO41104A00_8c.html#ae40ff337454f0c97fab6c6dde6fb70eb">test</a>;        <span class="comment">// TODO remove: test ank</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00243"></a>00243 <span class="comment">// Implementation</span>
<a name="l00244"></a>00244 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="WEPO41104A00_8c.html#a840291bc02cba5474a4cb46a9b9566fe">00246</a> <span class="keywordtype">int</span> <a class="code" href="WEPO41104A00_8h.html#a840291bc02cba5474a4cb46a9b9566fe" title="Hauptroutine.">main</a>(<span class="keywordtype">void</span>)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     cli();          <span class="comment">// clear interrupt</span>
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <span class="comment">// TODO remove or edit</span>
<a name="l00251"></a>00251     <span class="comment">//init_wdt();       // watchdog initialization</span>
<a name="l00252"></a>00252     <span class="comment">//init_wdt_int();</span>
<a name="l00253"></a>00253     
<a name="l00254"></a>00254     <a class="code" href="WEPO41104A00_8h.html#a4ae6edab9a918f82c63b98920fa10f1c" title="Grundlegende initialisierungen des Controlers und der Peripherie.">avr_init</a>();     <span class="comment">// controller initialization </span>
<a name="l00255"></a>00255     
<a name="l00256"></a>00256     int16_t SG_value[4] = {0};
<a name="l00257"></a>00257     int16_t *p_SG_value = SG_value;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">/* Use acceleration sensor? */</span>
<a name="l00260"></a>00260     <span class="keywordflow">if</span> (<a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a>)
<a name="l00261"></a>00261     {
<a name="l00262"></a>00262         <span class="keywordflow">if</span> (!(ACSR &amp; 0x20)) 
<a name="l00263"></a>00263             <a class="code" href="pm__config__protocol_8h.html#a8ea54d2c5521603b34fe4203c3b399f0">set_sleep</a>();    <span class="comment">// radial acceleration under threshold --&gt; sleep</span>
<a name="l00264"></a>00264         <span class="keywordflow">else</span>
<a name="l00265"></a>00265             <a class="code" href="WEPO41104A00_8h.html#aedc96a40e844bc2efc8bbef1b0782702" title="Startroutine zum Verlassen des Standby-Modus.">start</a>();        <span class="comment">// radial acceleration over threshold --&gt; start measurment</span>
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267     <span class="keywordflow">else</span>
<a name="l00268"></a>00268     {
<a name="l00269"></a>00269         <span class="keywordflow">if</span> ( !(PIND &amp; 0x20))
<a name="l00270"></a>00270             <a class="code" href="WEPO41104A00_8h.html#aedc96a40e844bc2efc8bbef1b0782702" title="Startroutine zum Verlassen des Standby-Modus.">start</a>();        <span class="comment">// Spike is not charging --&gt; start measurment</span>
<a name="l00271"></a>00271         <span class="keywordflow">else</span>
<a name="l00272"></a>00272             <a class="code" href="pm__config__protocol_8h.html#a8ea54d2c5521603b34fe4203c3b399f0">set_sleep</a>();    <span class="comment">// Spike is charging --&gt; sleep</span>
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="comment">/* ------------------ LOOP FOREVER ------------------------- */</span>
<a name="l00276"></a>00276     <span class="keywordflow">for</span> (;;)
<a name="l00277"></a>00277     {
<a name="l00278"></a>00278         <span class="comment">/* REQ_CFG CMD received? */</span>
<a name="l00279"></a>00279         <span class="keywordflow">if</span> (at86rf231_rx_frame.<a class="code" href="structat86rf231__frame.html#a5c856872df7ffcd650fb1c0ebe1f2f3e">payload</a>[0] != 0x00)
<a name="l00280"></a>00280         {
<a name="l00281"></a>00281             <span class="comment">/* Reset CMD */</span>
<a name="l00282"></a>00282             <span class="comment">//at86rf231_rx_frame.payload[0] = 0x00;</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284             _delay_ms(40); 
<a name="l00285"></a>00285 
<a name="l00286"></a>00286             <span class="comment">/* Receive and process data */</span>
<a name="l00287"></a>00287             <a class="code" href="pm__config__protocol_8h.html#abcc456d73d4fc7a801c502e2ccf9b5c9" title="Behandelt empfangene Pakete zur Konfiguration.">pm_config_protocol</a>();
<a name="l00288"></a>00288         }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <span class="comment">/* If spike is charging --&gt; sleep mode */</span>
<a name="l00291"></a>00291         <span class="keywordflow">if</span> (PIND &amp; 0x20)
<a name="l00292"></a>00292         {
<a name="l00293"></a>00293             <a class="code" href="pm__config__protocol_8h.html#a8ea54d2c5521603b34fe4203c3b399f0">set_sleep</a>();
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="comment">/* timeout occurred --&gt; sleep mode */</span>
<a name="l00297"></a>00297         <span class="keywordflow">if</span> ((<a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a> &gt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>.<a class="code" href="structeeprom__data.html#af2be052f091d31f650c635f4bfd3f873">timeout</a> * <a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>.<a class="code" href="structeeprom__data.html#a41f5e80711c080ba2e96138d33fd640e">samplerate</a>) &amp;&amp; <a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a>)
<a name="l00298"></a>00298         {
<a name="l00299"></a>00299             <a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a> = 0;
<a name="l00300"></a>00300             <a class="code" href="pm__config__protocol_8h.html#a8ea54d2c5521603b34fe4203c3b399f0">set_sleep</a>();
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="comment">/* Radialbeschleunigung vorhanden: timeout_timer zurücksetzten */</span>
<a name="l00304"></a>00304         <span class="keywordflow">if</span> ((<a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a> == 1) &amp;&amp; (!(ACSR &amp; 0x20)))
<a name="l00305"></a>00305         {
<a name="l00306"></a>00306             <a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a> = 0;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="keywordflow">if</span> (<a class="code" href="WEPO41104A00_8c.html#accb4ae119b6b85eda30f468b716c6b83">timer_flag</a>)
<a name="l00310"></a>00310         {
<a name="l00311"></a>00311             <a class="code" href="WEPO41104A00_8c.html#accb4ae119b6b85eda30f468b716c6b83">timer_flag</a> = 0;
<a name="l00312"></a>00312             
<a name="l00313"></a>00313             <span class="comment">/* increase timeout_timer */</span>
<a name="l00314"></a>00314             <a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a>++;
<a name="l00315"></a>00315             
<a name="l00316"></a>00316 <span class="preprocessor">            #if defined(USE_DS620)</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>            <span class="comment">// increase temperature timer</span>
<a name="l00318"></a>00318             <a class="code" href="WEPO41104A00_8c.html#a6a816a46f11405edf3d5659f16cf292a">temperature_timer</a>++;
<a name="l00319"></a>00319 <span class="preprocessor">            #endif</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span>            
<a name="l00321"></a>00321             <a class="code" href="conf__LED_8h.html#af2e697ac60e05813d45ea2c9c9e79c25">LED_ON</a>; 
<a name="l00322"></a>00322             <span class="comment">/* Read data from Sx8723c 1-4 */</span>
<a name="l00323"></a>00323             <a class="code" href="group__group__SX8723c__service.html#ga0a84d3b06d6266f36c42a8733fb06db8">SX8723c_send_request</a>(<a class="code" href="conf__sw__twi_8h.html#a7bdb5039dd8160773adc99bf5b068a1a">device_all</a>);   <span class="comment">// TODO wieder anschalten</span>
<a name="l00324"></a>00324             
<a name="l00325"></a>00325             <span class="comment">//DDRB |= (1 &lt;&lt; PINB4); // ank</span>
<a name="l00326"></a>00326             <span class="comment">//PORTB |= (1 &lt;&lt; PINB4); // (für Debugzwecke) ank</span>
<a name="l00327"></a>00327             <a class="code" href="group__group__SX8723c__service.html#ga3e3069b7bc89d4641dc095f22e24d136">SX8723c_get_value</a>(<a class="code" href="conf__sw__twi_8h.html#a7bdb5039dd8160773adc99bf5b068a1a">device_all</a>, p_SG_value);
<a name="l00328"></a>00328             <span class="comment">//PORTB &amp;= ~(1 &lt;&lt; PINB4); // (für Debugzwecke) ank</span>
<a name="l00329"></a>00329             
<a name="l00330"></a>00330             <a class="code" href="conf__LED_8h.html#a80700bb63bd56ebabbb4728aa433fd29">LED_OFF</a>; 
<a name="l00331"></a>00331             
<a name="l00332"></a>00332             <span class="comment">/* store data in payload */</span>
<a name="l00333"></a>00333             ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#adcbddf2044dfae793b1899facff69eee">strain_gauge</a>[<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a>][<a class="code" href="WEPO41104A00_8h.html#a00fb01449721637b05522f7dce004d82">SG_1</a>] = SG_value[<a class="code" href="WEPO41104A00_8h.html#a00fb01449721637b05522f7dce004d82">SG_1</a>] - ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a4e2ee5aa1a05e9e5c607e9b7322b28b1">SG_software_offset</a>[<a class="code" href="WEPO41104A00_8h.html#a00fb01449721637b05522f7dce004d82">SG_1</a>];
<a name="l00334"></a>00334             ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#adcbddf2044dfae793b1899facff69eee">strain_gauge</a>[<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a>][<a class="code" href="WEPO41104A00_8h.html#a12dfc14867c2e6f95cd72a522c096cc1">SG_2</a>] = SG_value[<a class="code" href="WEPO41104A00_8h.html#a12dfc14867c2e6f95cd72a522c096cc1">SG_2</a>] - ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a4e2ee5aa1a05e9e5c607e9b7322b28b1">SG_software_offset</a>[<a class="code" href="WEPO41104A00_8h.html#a12dfc14867c2e6f95cd72a522c096cc1">SG_2</a>];
<a name="l00335"></a>00335             ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#adcbddf2044dfae793b1899facff69eee">strain_gauge</a>[<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a>][<a class="code" href="WEPO41104A00_8h.html#a9a44239083781468ed0f995387ac635d">SG_3</a>] = SG_value[<a class="code" href="WEPO41104A00_8h.html#a9a44239083781468ed0f995387ac635d">SG_3</a>] - ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a4e2ee5aa1a05e9e5c607e9b7322b28b1">SG_software_offset</a>[<a class="code" href="WEPO41104A00_8h.html#a9a44239083781468ed0f995387ac635d">SG_3</a>];
<a name="l00336"></a>00336             ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#adcbddf2044dfae793b1899facff69eee">strain_gauge</a>[<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a>][<a class="code" href="WEPO41104A00_8h.html#a2bd4405aaa8c7ac662e5ce138ef0090b">SG_4</a>] = SG_value[<a class="code" href="WEPO41104A00_8h.html#a2bd4405aaa8c7ac662e5ce138ef0090b">SG_4</a>] - ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a4e2ee5aa1a05e9e5c607e9b7322b28b1">SG_software_offset</a>[<a class="code" href="WEPO41104A00_8h.html#a2bd4405aaa8c7ac662e5ce138ef0090b">SG_4</a>];
<a name="l00337"></a>00337     
<a name="l00338"></a>00338             <span class="comment">/* Timeslot++ */</span>
<a name="l00339"></a>00339             <a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a>++;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341             <span class="comment">/* send data with radio if necessary */</span>
<a name="l00342"></a>00342             <span class="keywordflow">if</span> (<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a> &gt;= <a class="code" href="at86_8h.html#ae6e677a01ad8ab8134ffc7a68b814048">SAMPLES_PER_PACKET</a>)
<a name="l00343"></a>00343             {
<a name="l00344"></a>00344                 <a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a> = 0;
<a name="l00345"></a>00345                 <a class="code" href="WEPO41104A00_8c.html#ab9955d15183797bee64862444d572183">send_all_data_rf231</a>();
<a name="l00346"></a>00346             }               
<a name="l00347"></a>00347             
<a name="l00348"></a>00348             <span class="comment">/* Reset watchdog */</span>
<a name="l00349"></a>00349             wdt_reset();
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         
<a name="l00353"></a>00353 <span class="preprocessor">#if defined(USE_DS620)</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>        <span class="comment">// Temperaturmessung staren wenn 200ms vorbei und DMS gerade nicht messen und nicht gesendet wird.</span>
<a name="l00355"></a>00355         <span class="keywordflow">if</span>( (<a class="code" href="WEPO41104A00_8c.html#a6a816a46f11405edf3d5659f16cf292a">temperature_timer</a> &gt;= (<a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>.<a class="code" href="structeeprom__data.html#a41f5e80711c080ba2e96138d33fd640e">samplerate</a> / 9)) &amp; (<a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a> == 3))
<a name="l00356"></a>00356         {
<a name="l00357"></a>00357                     <a class="code" href="WEPO41104A00_8c.html#a38c1c68ba82dd107cf6dddbc7a564dfd">temperature</a> = <a class="code" href="ds620_8c.html#a3f2e6a267be5098a09273824a5887d74" title="liest einen Temperaturwert vom DS620">ds620_get_temperature</a>();
<a name="l00358"></a>00358                     <a class="code" href="WEPO41104A00_8c.html#a6a816a46f11405edf3d5659f16cf292a">temperature_timer</a> = 0;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 <span class="preprocessor">#endif</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>
<a name="l00362"></a>00362     } <span class="comment">// end for()</span>
<a name="l00363"></a>00363     <span class="keywordflow">return</span> (0);
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a><a class="code" href="WEPO41104A00_8c.html#a9fd49949e35eb5a3e7bb240e94b114d2">00366</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8c.html#a9fd49949e35eb5a3e7bb240e94b114d2">init_wdt_int</a>(<span class="keywordtype">void</span>)
<a name="l00367"></a>00367 {   
<a name="l00368"></a>00368     wdt_reset();
<a name="l00369"></a>00369     MCUSR &amp;= ~(1 &lt;&lt; WDRF); <span class="comment">// Bit löschen </span>
<a name="l00370"></a>00370     
<a name="l00371"></a>00371     WDTCSR |= (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE);                 <span class="comment">// Start timed sequence</span>
<a name="l00372"></a>00372     WDTCSR = ((1 &lt;&lt; WDIE)|(1 &lt;&lt; WDP3)|(1 &lt;&lt; WDP0)|(1 &lt;&lt; WDE));      <span class="comment">// Watchdog ~8s, interrupt-mode</span>
<a name="l00373"></a>00373 }   
<a name="l00374"></a>00374 
<a name="l00375"></a><a class="code" href="WEPO41104A00_8c.html#a51d97a32f6f5162b3c8eab9d48d78b4f">00375</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8h.html#a51d97a32f6f5162b3c8eab9d48d78b4f">init_wdt</a>(<span class="keywordtype">void</span>)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <span class="comment">//WDTCSR |= (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE);       // watchdog enable</span>
<a name="l00378"></a>00378     WDTCSR |= ((1 &lt;&lt; WDCE) | (1 &lt;&lt; WDIE));      <span class="comment">// watchdog enable</span>
<a name="l00379"></a>00379     WDTCSR = 0x29;                          <span class="comment">// Watchdog 8s, reset-mode</span>
<a name="l00380"></a>00380     wdt_reset();    
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a><a class="code" href="WEPO41104A00_8c.html#a7b8ab79df77b57475a5494f5f81c3bd9">00383</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8h.html#a7b8ab79df77b57475a5494f5f81c3bd9" title="Initialisiert den Timer1 auf Interrupt im Intervall der Samplerate.">timer_init</a>(<span class="keywordtype">void</span>) <span class="comment">// Timer-Einstellungen</span>
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     TCCR1A = 0x00; <span class="comment">// CTC (clear timer on compare)</span>
<a name="l00386"></a>00386     TCCR1B = 0x09; <span class="comment">// CTC, no prescaling</span>
<a name="l00387"></a>00387     OCR1A = (<span class="keywordtype">unsigned</span> short) ((<span class="keywordtype">float</span>) <a class="code" href="pal__config_8h.html#a43bafb28b29491ec7f871319b5a3b2f8">F_CPU</a>
<a name="l00388"></a>00388             / (float) <a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>.<a class="code" href="structeeprom__data.html#a41f5e80711c080ba2e96138d33fd640e">samplerate</a>); <span class="comment">// Timer auf Samplerate einstellen</span>
<a name="l00389"></a>00389     TCNT1 = 0x0000;
<a name="l00390"></a>00390     OCR1B = 0x0000;
<a name="l00391"></a>00391     ICR1 = 0x0000;
<a name="l00392"></a>00392     TIMSK1 = 1 &lt;&lt; OCIE1A; <span class="comment">// Timer1 Output Compare A Match, interrupt enable</span>
<a name="l00393"></a>00393     TIFR1 = 0x02;       <span class="comment">// clear output compare a match flag</span>
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="WEPO41104A00_8c.html#a4ae6edab9a918f82c63b98920fa10f1c">00396</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8h.html#a4ae6edab9a918f82c63b98920fa10f1c" title="Grundlegende initialisierungen des Controlers und der Peripherie.">avr_init</a>(<span class="keywordtype">void</span>) <span class="comment">// Initialization</span>
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     MCUCR &amp;= ~(1 &lt;&lt; PUD);   <span class="comment">// enable internal pull ups </span>
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     PRR0 = 0x00;        <span class="comment">// power manager: enable all modules</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="comment">/* Set system clock prescaler */</span>
<a name="l00403"></a>00403     CLKPR = 0x80;
<a name="l00404"></a>00404     CLKPR = 0x00; <span class="comment">// prescaler to 1</span>
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     DDRA = 0x00;
<a name="l00407"></a>00407     PORTA = 0x1F;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     DDRB = 0xB1;
<a name="l00410"></a>00410     PORTB = 0x50;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     DDRC = 0xC0;
<a name="l00413"></a>00413     PORTC = 0x80;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     DDRD = (1 &lt;&lt; PIND4) | (1 &lt;&lt; PIND7);     <span class="comment">// 1 = output, 0 = input </span>
<a name="l00416"></a>00416     PORTD = (1 &lt;&lt; PIND4) | ( 1 &lt;&lt; PIND7);   <span class="comment">// 1 = high, 0 = low </span>
<a name="l00417"></a>00417     
<a name="l00418"></a>00418     <a class="code" href="conf__LED_8h.html#a890a7b756538547816bf1d293d55f08f">INIT_LED</a>;
<a name="l00419"></a>00419     
<a name="l00420"></a>00420     DDRB |= (1 &lt;&lt; PINB4); <span class="comment">// ank debug</span>
<a name="l00421"></a>00421     PORTB &amp;= ~(1 &lt;&lt; PINB4); <span class="comment">// (für Debugzwecke) ank </span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <a class="code" href="eeprom__abbild_8c.html#a741f4f6bf07cdfdbf182dd34028fdd12" title="Load configuration from internal EEPROM and save it in SRAM.">eeprom_read_config</a>(ptr_eeprom_sram_data);   <span class="comment">// store EEPROM data to SRAM (faster access)</span>
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="comment">/* if timeout = 0 --&gt; deaktivate acceleration sensor, always on */</span>
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (<a class="code" href="pm__config__protocol_8h.html#a7f3aacb710fc6ba60196588850cf6d15">eeprom_sram_data</a>.<a class="code" href="structeeprom__data.html#af2be052f091d31f650c635f4bfd3f873">timeout</a> == 0)
<a name="l00427"></a>00427     {
<a name="l00428"></a>00428         <a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a> = 0;
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430     <span class="keywordflow">else</span>
<a name="l00431"></a>00431     {
<a name="l00432"></a>00432         <a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a> = 1;
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     
<a name="l00435"></a>00435 <span class="preprocessor">#if defined(USE_DS620)</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>    <a class="code" href="ds620_8c.html#a126fb46cf24425d874541b7f95a927b7" title="Initialisiert die TWI für den Temperatursensor.">ds620_twi_init</a>();
<a name="l00437"></a>00437 <span class="preprocessor">#endif</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>
<a name="l00439"></a>00439     <a class="code" href="group__group__SX8723c__service.html#ga528d11c1bcefe1ac4489e8dae24a4711">SX8723c_init</a>(<a class="code" href="conf__sw__twi_8h.html#a21cf31a4465229adb58665938b64811d">device_1</a>);
<a name="l00440"></a>00440     <a class="code" href="group__group__SX8723c__service.html#ga528d11c1bcefe1ac4489e8dae24a4711">SX8723c_init</a>(<a class="code" href="conf__sw__twi_8h.html#a14594221af7e11a756654797e3a97491">device_2</a>);
<a name="l00441"></a>00441     <a class="code" href="group__group__SX8723c__service.html#ga528d11c1bcefe1ac4489e8dae24a4711">SX8723c_init</a>(<a class="code" href="conf__sw__twi_8h.html#a90ca18d19efd874dcfab959b476c40aa">device_3</a>);
<a name="l00442"></a>00442     <a class="code" href="group__group__SX8723c__service.html#ga528d11c1bcefe1ac4489e8dae24a4711">SX8723c_init</a>(<a class="code" href="conf__sw__twi_8h.html#a43e27f6fc03bf09854fc1d4170ceddf0">device_4</a>);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     ACSR = 0x82; <span class="comment">// analog-comparator off, comparator Interrupt on Falling Output Edge</span>
<a name="l00445"></a>00445     <a class="code" href="WEPO41104A00_8h.html#a7b8ab79df77b57475a5494f5f81c3bd9" title="Initialisiert den Timer1 auf Interrupt im Intervall der Samplerate.">timer_init</a>(); <span class="comment">// timer initialization</span>
<a name="l00446"></a>00446     
<a name="l00447"></a>00447     <span class="comment">/* adc init */</span>
<a name="l00448"></a>00448     <a class="code" href="WEPO41104A00_8h.html#ab15cf82f0329bc4d7262c03559eaaa8e">init_adc</a>();
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <a class="code" href="at86rf231_8c.html#a95cd6b5d19a0129a7b6ccb6ce985a790" title="Init AT86RF231 Transceiver.">at86rf231_init</a>();   <span class="comment">// AT86RF231 initialization</span>
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a><a class="code" href="WEPO41104A00_8c.html#ab15cf82f0329bc4d7262c03559eaaa8e">00453</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8h.html#ab15cf82f0329bc4d7262c03559eaaa8e">init_adc</a>(<span class="keywordtype">void</span>)
<a name="l00454"></a>00454 {
<a name="l00455"></a>00455     ADMUX = (1 &lt;&lt; REFS1) | (1 &lt;&lt; ADLAR) | (1 &lt;&lt; MUX0) | (1 &lt;&lt; MUX1) | (1
<a name="l00456"></a>00456             &lt;&lt; MUX2); <span class="comment">// ADC7, Left Adjust, 1.1V Ref</span>
<a name="l00457"></a>00457     ADCSRA = (1 &lt;&lt; ADSC) | (1 &lt;&lt; ADATE) | (1 &lt;&lt; ADEN) | (1 &lt;&lt; ADPS2) | (1
<a name="l00458"></a>00458             &lt;&lt; ADPS0); <span class="comment">// ADC enable, Start conversion, AutoTrigger enable, Prescaler: 32</span>
<a name="l00459"></a>00459     ADCSRB = 0;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="WEPO41104A00_8c.html#aedc96a40e844bc2efc8bbef1b0782702">00462</a> <span class="keywordtype">void</span> <a class="code" href="WEPO41104A00_8h.html#aedc96a40e844bc2efc8bbef1b0782702" title="Startroutine zum Verlassen des Standby-Modus.">start</a>(<span class="keywordtype">void</span>) <span class="comment">// in Aktiv-Modus schalten</span>
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464     cli();
<a name="l00465"></a>00465     
<a name="l00466"></a>00466     PRR0 = 0x00;        <span class="comment">// power manager: enable all modules</span>
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     <span class="comment">/* Set system clock prescaler */</span>
<a name="l00469"></a>00469     CLKPR = 0x80;
<a name="l00470"></a>00470     CLKPR = 0x00; <span class="comment">// prescaler to 1</span>
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (<a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a>)
<a name="l00473"></a>00473     {
<a name="l00474"></a>00474         ACSR = 0x12; <span class="comment">// analog-Komperator an, Interrupt aus</span>
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     
<a name="l00477"></a>00477     <span class="comment">/* adc init */</span>
<a name="l00478"></a>00478     <a class="code" href="WEPO41104A00_8h.html#ab15cf82f0329bc4d7262c03559eaaa8e">init_adc</a>();
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="preprocessor">#if defined(USE_DS620)</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span>    <span class="comment">/* init temperature sensor */</span>
<a name="l00482"></a>00482     <a class="code" href="ds620_8c.html#aa8ab08bf72368a272b8e137b37292ad9" title="Initialisiert den DS620.">ds620_init</a>();
<a name="l00483"></a>00483 <span class="preprocessor">#endif</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>
<a name="l00485"></a>00485     <a class="code" href="group__group__SX8723c__service.html#ga6e062d659b6b58d80823c2b664ec17f0">SX8723c_start</a>(<a class="code" href="conf__sw__twi_8h.html#a7bdb5039dd8160773adc99bf5b068a1a">device_all</a>);
<a name="l00486"></a>00486     
<a name="l00487"></a>00487     <span class="comment">// reset time_slot to avoid sending old data; ank</span>
<a name="l00488"></a>00488     <a class="code" href="ZMD_8h.html#a7deb9081234bdc9cdb6069bb8f05cf6a">timeslot_number</a> = 0; 
<a name="l00489"></a>00489     
<a name="l00490"></a>00490     <a class="code" href="pm__config__protocol_8h.html#ab14eb7224e6881cf15cb95391749de25">timeout_timer</a> = 0;
<a name="l00491"></a>00491     
<a name="l00492"></a>00492     <span class="comment">// start timer</span>
<a name="l00493"></a>00493     TCCR1B = 0x09; <span class="comment">// CTC, no prescaling</span>
<a name="l00494"></a>00494     TIFR1 = 0x02;       <span class="comment">// clear output compare a match flag</span>
<a name="l00495"></a>00495     
<a name="l00496"></a>00496     sei();
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a><a class="code" href="WEPO41104A00_8c.html#a8ea54d2c5521603b34fe4203c3b399f0">00499</a> <span class="keywordtype">void</span> <a class="code" href="pm__config__protocol_8h.html#a8ea54d2c5521603b34fe4203c3b399f0">set_sleep</a>(<span class="keywordtype">void</span>) <span class="comment">// in Standby-Modus schalten</span>
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501     cli();
<a name="l00502"></a>00502     
<a name="l00503"></a>00503     TCCR1B = 0x00; <span class="comment">// Timer stoppen</span>
<a name="l00504"></a>00504     TIFR1 = 0x02; <span class="comment">// Output Compare A Match Flag reset</span>
<a name="l00505"></a>00505     
<a name="l00506"></a>00506     <span class="comment">// SX8723c and strain gauges off</span>
<a name="l00507"></a>00507     <a class="code" href="group__group__SX8723c__service.html#ga0d15afac6ea5710926527bcfd9cfb4c8">SX8723c_sleep</a>(<a class="code" href="conf__sw__twi_8h.html#a7bdb5039dd8160773adc99bf5b068a1a">device_all</a>);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="preprocessor">#if defined(USE_DS620)</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span>    <a class="code" href="ds620_8c.html#a7e0a9a05879cfb77b9cd5abc9bd545fa" title="versetzt den DS620 in den Sleep-Modus">ds620_sleep</a>(); <span class="comment">// Temperatursensor stoppen</span>
<a name="l00511"></a>00511 <span class="preprocessor">#endif</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span>
<a name="l00513"></a>00513     ADCSRA = 0x00; <span class="comment">// ADC off</span>
<a name="l00514"></a>00514     
<a name="l00515"></a>00515     <a class="code" href="at86rf231_8c.html#ad4bc4925ecdde78387866127fb66d3b3" title="Set Transceiver mode = sleep.">at86rf231_sleep</a>(); <span class="comment">// Transceiver in Power-down</span>
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     CLKPR = 0x80;
<a name="l00518"></a>00518     CLKPR = 0x03; <span class="comment">//08         // Prescaler 8</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     PRR0 = 0xFE;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (<a class="code" href="pm__config__protocol_8h.html#a6ec8e1d5423a97287f5095d86ce2cff7">besch_start_flag</a>)
<a name="l00523"></a>00523     {
<a name="l00524"></a>00524         ACSR = 0x1A; <span class="comment">// analog-Komperator an, Interrupt bei fallender Flanke</span>
<a name="l00525"></a>00525         set_sleep_mode(SLEEP_MODE_IDLE);
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527     <span class="keywordflow">else</span>
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529         set_sleep_mode(SLEEP_MODE_PWR_SAVE);
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531     
<a name="l00532"></a>00532     wdt_reset();        <span class="comment">//ank</span>
<a name="l00533"></a>00533     sleep_enable();
<a name="l00534"></a>00534     sei();
<a name="l00535"></a>00535     sleep_cpu(); <span class="comment">// IDLE-Modus</span>
<a name="l00536"></a>00536     sleep_disable();
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a><a class="code" href="WEPO41104A00_8c.html#ab9955d15183797bee64862444d572183">00539</a> <span class="keywordtype">void</span> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="WEPO41104A00_8c.html#ab9955d15183797bee64862444d572183">send_all_data_rf231</a>(<span class="keywordtype">void</span>)
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541     <span class="keyword">static</span> <span class="keyword">volatile</span> uint16_t frame_counter = 0;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">/* Build frame to transmit */</span>
<a name="l00544"></a>00544     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#aeb9ee25221773af668c06c96313f22f7">frame_length</a> = <span class="keyword">sizeof</span>(<a class="code" href="structspike__payload.html" title="Spike tx payload data struct.">spike_payload</a>) + 13;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#a0b60db329d4d6702311e6b1386a9d3fc">frame_control_field</a>
<a name="l00547"></a>00547             = <a class="code" href="ieee__const_8h.html#a0827103b61e6977b4aa88785b44c5783">FCF_SET_FRAMETYPE</a>( <a class="code" href="ieee__const_8h.html#af7f31c2eb2bfba6f08d4bc6eb040417e">FCF_FRAMETYPE_DATA</a> )
<a name="l00548"></a>00548                     | <a class="code" href="ieee__const_8h.html#a98b735bad11e0561b4c9698ff6381df4">FCF_SET_DEST_ADDR_MODE</a>( <a class="code" href="ieee__const_8h.html#aa24f727f40b79dcb2a5a3d2304c2785b">FCF_SHORT_ADDR</a> )
<a name="l00549"></a>00549                     | <a class="code" href="ieee__const_8h.html#a427c247ea77df8419a5369b74da0569c">FCF_SET_SOURCE_ADDR_MODE</a>( <a class="code" href="ieee__const_8h.html#aa24f727f40b79dcb2a5a3d2304c2785b">FCF_SHORT_ADDR</a> );
<a name="l00550"></a>00550     <span class="comment">// |FCF_ACK_REQUEST;</span>
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#aa22137353acb974e49c979cd616d389e">seq_number</a> = (uint8_t) frame_counter &amp; 0xFF;
<a name="l00553"></a>00553     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#a761c7a0b668e753aa11a67096e1dd2fb">dest_pan_id</a> = ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a44ed4dca3b9dc58bb7c62367f821ebad">pan_id</a>;
<a name="l00554"></a>00554     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#abd4abc3d5412cf5921d0ee605ddc7132">dest_addr</a> = ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a62c854ac33b1d470de800468a2995e34">dest_address</a>;
<a name="l00555"></a>00555     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#a6540ac144dac87dfb0411acd4dc841cb">src_pan_id</a> = ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a44ed4dca3b9dc58bb7c62367f821ebad">pan_id</a>;
<a name="l00556"></a>00556     at86rf231_tx_frame.<a class="code" href="structat86rf231__frame.html#a1b4415edc566172332d8d00947fc2837">src_addr</a> = ptr_eeprom_sram_data-&gt;<a class="code" href="structeeprom__data.html#a352745e056326beab6c74345f10eb144">src_address</a>;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="comment">/* Add counter to payload */</span>
<a name="l00559"></a>00559     ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#adfcfba518d1caef6cedf1ed0e10d950a">counter</a> = frame_counter++;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <span class="comment">/* Add temperature to payload */</span>
<a name="l00562"></a>00562     ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#a59448005bdba97db086b40ec1805e915">temperature</a> = <a class="code" href="WEPO41104A00_8c.html#a38c1c68ba82dd107cf6dddbc7a564dfd">temperature</a>;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     <span class="comment">/* Add voltage to payload */</span>
<a name="l00565"></a>00565     ptr_payload_spike-&gt;<a class="code" href="structspike__payload.html#a1d7e3b3750609819b948222e38d55042">voltage</a> = ADCH; 
<a name="l00566"></a>00566     <span class="comment">//ptr_payload_spike-&gt;voltage = 100; //ank</span>
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">/* tx data */</span>
<a name="l00569"></a>00569     <a class="code" href="at86rf231_8c.html#a9e5cb2ff642e1ad6dcb9c02bafd10229" title="Send data without ACK and Retry.">at86rf231_tx</a>();
<a name="l00570"></a>00570     <span class="comment">//at86rf231_tx_with_retry(CSMA_UNSLOTTED, 1); //ank</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00576"></a>00576 <span class="comment">// Interrupts</span>
<a name="l00577"></a>00577 <span class="comment">//-----------------------------------------------------------------------------------------------//</span>
<a name="l00578"></a>00578 
<a name="l00579"></a><a class="code" href="WEPO41104A00_8c.html#ad39420cdd896dd12c68e36313139d0a5">00579</a> <a class="code" href="WEPO41104A00_8h.html#ad39420cdd896dd12c68e36313139d0a5" title="Timerinterrupt, wird SAPLERATE mal in der Sekunde ausgeführt.">ISR</a>( TIMER1_COMPA_vect )
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581     DDRA |= (1 &lt;&lt; PIND6);
<a name="l00582"></a>00582     PORTA |= (1 &lt;&lt; PIND6); <span class="comment">// TXD auf 0 (für Debugzwecke) ank</span>
<a name="l00583"></a>00583     <span class="comment">/* Reset timer flag */</span>
<a name="l00584"></a>00584     <a class="code" href="WEPO41104A00_8c.html#accb4ae119b6b85eda30f468b716c6b83">timer_flag</a> = 1;
<a name="l00585"></a>00585     
<a name="l00586"></a>00586     <span class="comment">//sw_TWI_write_single_register(0x0F, 0x40, 0x55);   //ank</span>
<a name="l00587"></a>00587     <span class="comment">//sw_TWI_read_value_registers(0x0F, p_test);    //ank</span>
<a name="l00588"></a>00588     
<a name="l00589"></a>00589     PORTA &amp;= ~(1 &lt;&lt; PIND6); <span class="comment">// TXD auf 0 (für Debugzwecke) ank</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 
<a name="l00594"></a><a class="code" href="WEPO41104A00_8c.html#a36cd53f29e25f87810b0a5156616fb99">00594</a> <a class="code" href="WEPO41104A00_8h.html#ad39420cdd896dd12c68e36313139d0a5" title="Timerinterrupt, wird SAPLERATE mal in der Sekunde ausgeführt.">ISR</a>( ANALOG_COMP_vect )
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596     <span class="comment">/* Spike is not charging */</span>
<a name="l00597"></a>00597     <span class="keywordflow">if</span>( !(PIND&amp;0x20) )
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599         <span class="comment">/* start measuring */</span>
<a name="l00600"></a>00600         <a class="code" href="WEPO41104A00_8h.html#aedc96a40e844bc2efc8bbef1b0782702" title="Startroutine zum Verlassen des Standby-Modus.">start</a>();
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602     <span class="keywordflow">else</span>
<a name="l00603"></a>00603     {
<a name="l00604"></a>00604         <span class="comment">/* sleep again if spike is already charging */</span>
<a name="l00605"></a>00605         ACSR = 0x1A; <span class="comment">// analog-Komperator an, Interrupt bei fallender Flanke</span>
<a name="l00606"></a>00606         set_sleep_mode(SLEEP_MODE_IDLE);
<a name="l00607"></a>00607     
<a name="l00608"></a>00608         wdt_reset();        <span class="comment">//ank</span>
<a name="l00609"></a>00609         sleep_enable();
<a name="l00610"></a>00610         sei();
<a name="l00611"></a>00611         sleep_cpu(); <span class="comment">// IDLE-Modus</span>
<a name="l00612"></a>00612         sleep_disable();
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="WEPO41104A00_8c.html#a43905d6fb5c4d433a49f527fa6ab811f">00616</a> <a class="code" href="WEPO41104A00_8h.html#ad39420cdd896dd12c68e36313139d0a5" title="Timerinterrupt, wird SAPLERATE mal in der Sekunde ausgeführt.">ISR</a>( WDT_vect )
<a name="l00617"></a>00617 {
<a name="l00618"></a>00618     <a class="code" href="WEPO41104A00_8c.html#a481483ea06e2337faecb21a949a199f5">wdt_interrupt_occurred</a> = <span class="keyword">true</span>;
<a name="l00619"></a>00619 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 26 2013 14:36:47 for SPIKE 1.1 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
